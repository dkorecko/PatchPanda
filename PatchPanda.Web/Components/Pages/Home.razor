@page "/"
@inject DockerService _dockerService
@inject IDbContextFactory<DataContext> _dbContextFactory
@inject NavigationManager _nav

<PageTitle>Home</PageTitle>

<h1>Compose stacks</h1>

@if (_composeStacks is null)
{
    <div class="spinner-grow" role="status">
        <span class="sr-only">Loading...</span>
    </div>
}
else
{
    <button class="btn btn-primary" type="button" disabled="@(_isReloading || _isRestarting)" @onclick="ReloadData">
        @if (_isReloading)
        {
            <span class="spinner-grow spinner-grow-sm" aria-hidden="true"></span>
        }
        else
        {
            <span>Recheck containers</span>
        }
    </button>

    int i = 0;
    <div class="accordion" id="stacksAccordion">
        @foreach (var context in _composeStacks.OrderBy(x => x.StackName))
        {
            var stackId = $"stack_{i}";
            i++;
            <div @key=stackId class="accordion-item">
                <h4 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#@stackId" aria-expanded="false" aria-controls="@stackId">
                        <b>@context.StackName</b>
                        @if(context.Apps.Count(x => x.NewerVersions.Any()) > 0)
                        {
                            <span class="badge text-bg-warning ms-2">@context.Apps.Count(x => x.NewerVersions.Any()) updates</span>
                        } else
                        {
                            <span class="badge text-bg-success ms-2">All up-to-date</span>
                        }
                        @if(context.Apps.Any(x => x.GitHubRepo is null && !x.IsSecondary))
                        {
                            <span class="badge text-bg-danger ms-2">Missing GitHub repo</span>
                        }
                        @if (context.Apps.Any(x => x.Version is null && !x.IsSecondary))
                        {
                            <span class="badge text-bg-danger ms-2">Missing version</span>
                        }
                        @if (context.Apps.Any(x => x.Regex is null && !x.IsSecondary))
                        {
                            <span class="badge text-bg-danger ms-2">Missing regex</span>
                        }
                    </button>
                </h4>
                <div id=@stackId class="accordion-collapse collapse" data-bs-parent="#stacksAccordion">
                    <div class="accordion-body">
                        <button class="btn btn-primary" type="button" disabled="@_isRestarting" @onclick="() => RestartStack(context)">
                            @if (_isRestarting)
                            {
                                <span class="spinner-grow spinner-grow-sm" aria-hidden="true"></span>
                            }
                            else
                            {
                                <span>Restart</span>
                            }
                        </button>
                        <table class="table-striped table-hover table-bordered table">
                            <thead>
                                <tr>
                                    <th scope="col">
                                        App name
                                    </th>
                                    <th scope="col">
                                        Github Repo
                                    </th>
                                    <th scope="col">
                                        Version
                                    </th>
                                    <th scope="col">
                                        Final regex
                                    </th>
                                    <th scope="col">
                                        Newer versions
                                    </th>
                                    <th scope="col">
                                        Current SHA
                                    </th>
                                    <th scope="col">
                                        Target image
                                    </th>
                                    <th scope="col">
                                        Notes
                                    </th>
                                    <th scope="col">
                                        Uptime
                                    </th>
                                    <th scope="col">
                                        Last version check
                                    </th>
                                    <th scope="col">
                                        Controls
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var app in context.Apps.OrderBy(x => x.Name))
                                {
                                    var newestVersion = app.NewerVersions?.FirstOrDefault();
                                    <tr>
                                        <td>@app.Name</td>
                                        <td>
                                            @if(app.GitHubRepo is null)
                                            {
                                                <span class="badge text-bg-warning">Missing</span>
                                            } else
                                            {
                                                var repoCombination = app.GitHubRepo.Item1 + "/" + app.GitHubRepo.Item2;
                                                <a href="https://github.com/@repoCombination" target="_blank">@repoCombination</a>

                                                if(app.SecondaryGitHubRepos is not null)
                                                {
                                                    <div>Secondary:</div>
                                                    @foreach(var secondary in app.SecondaryGitHubRepos)
                                                    {
                                                        var secondaryRepoCombination = secondary.Item1 + "/" + secondary.Item2;
                                                        <a href="https://github.com/@secondaryRepoCombination" target="_blank">@secondaryRepoCombination</a>
                                                    }
                                                }
                                            }
                                        </td>
                                        <td>
                                            @if (app.Version is null)
                                            {
                                                <span class="badge text-bg-warning">Missing</span>
                                            }
                                            else
                                            {
                                                <span class="badge text-bg-primary">@app.Version</span>
                                            }
                                        </td>
                                        <td>
                                            @if (app.Regex is null)
                                            {
                                                <span class="badge text-bg-warning">Missing</span>
                                            }
                                            else
                                            {
                                                @app.Regex
                                            }
                                        </td>
                                        <td>
                                            @if(newestVersion is null)
                                            {
                                                <span class="badge text-bg-success">Up to date</span>
                                            }
                                            else
                                            {
                                                <span class='badge text-bg-warning'>@newestVersion.VersionNumber</span>

                                                if(newestVersion.Notified)
                                                {
                                                    <span class="badge text-bg-info ms-1">Notified</span>
                                                }
                                            }
                                        </td>
                                        <td>@app.CurrentSha</td>
                                        <td>@app.TargetImage</td>
                                        <td>
                                            @if(app.MultiContainerApp is not null)
                                            {
                                                <span class="badge text-bg-info">@app.MultiContainerApp.AppName</span>
                                            }
                                            @if(app.IsSecondary)
                                            {
                                                <span class="badge text-bg-success">DB</span>
                                            }
                                        </td>
                                        <td>@app.Uptime</td>
                                        <td>@(app.LastVersionCheck.Equals(DateTime.MinValue) ? "Never" : app.LastVersionCheck.ToReadableStringWithTime())</td>
                                        <td>
                                            <a target="_blank" href="/versions/@app.Id" class="btn btn-primary">Releases</a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private List<ComposeStack>? _composeStacks;
    private bool _isRestarting;
    private bool _isReloading;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        await LoadData();
    }

    private async Task LoadData()
    {
        using var db = _dbContextFactory.CreateDbContext();

        _composeStacks = await db.Stacks
            .Include(x => x.Apps)
            .ThenInclude(x => x.NewerVersions)
            .Include(x => x.Apps)
            .ThenInclude(x => x.MultiContainerApp)
            .ToListAsync();

        StateHasChanged();
    }

    private async Task RestartStack(ComposeStack stack)
    {
        _isRestarting = true;
        StateHasChanged();
        await _dockerService.RunDockerComposeOnPath(stack, "restart");
        _isRestarting = false;
        StateHasChanged();
    }

    private async Task ReloadData()
    {
        _isReloading = true;
        StateHasChanged();
        await _dockerService.ResetComposeStacks();
        _isReloading = false;
        await LoadData();
    }
}