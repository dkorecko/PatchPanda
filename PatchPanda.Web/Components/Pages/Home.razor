@page "/"
@using System.Text.Json
@inject DockerService _dockerService
@inject FileService _fileService

<PageTitle>Home</PageTitle>

<h1>Hello, world!</h1>

@if (_composeStacks is null)
{
	<div class="spinner-grow" role="status">
		<span class="sr-only">Loading...</span>
	</div>
} else
{
    int i = 0;
    <div class="accordion" id="stacksAccordion">
        <Virtualize Items="_composeStacks">
            @{
                var stackId = $"stack_{i}";
                i++;
            }
            @foreach(var stack in _composeStacks) 
            {
                <div class="accordion-item">
                    <h4 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#@stackId" aria-expanded="false" aria-controls="@stackId">
                            Stack @context.StackName (@context.ConfigFile)
                        </button>
                    </h4>
                    <div id=@stackId class="accordion-collapse collapse" data-bs-parent="#stacksAccordion">
                        <div class="accordion-body">
                            <table class="table-striped table-hover table-bordered table">
                                <thead>
                                    <tr>
                                        <th scope="col">
                                            App name
                                        </th>
                                        <th scope="col">
                                            Github Repo
                                        </th>
                                        <th scope="col">
                                            Version
                                        </th>
                                        <th scope="col">
                                            Current SHA
                                        </th>
                                        <th scope="col">
                                            Uptime
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var app in context.Apps)
                                    {
                                        <tr>
                                            <td>@app.Name</td>
                                            <td>@app.GitHubRepo</td>
                                            <td>@app.Version</td>
                                            <td>@app.CurrentSha</td>
                                            <td>@app.Uptime</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </Virtualize>
    </div>
}

@code {
	private IList<ComposeStack>? _composeStacks;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (!firstRender)
			return;

		_composeStacks = await _dockerService.GetAllComposeStacks();
		StateHasChanged();
	}


}